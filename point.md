# Go æ€§èƒ½é™·é˜±ï¼šä¼ æŒ‡é’ˆä¸€å®šæ¯”ä¼ å€¼å¿«ï¼Ÿ

åœ¨ Go åœˆå­é‡Œï¼Œæœ‰ä¸€å¥æµä¼ ç”šå¹¿çš„â€œæ€§èƒ½åœ£ç»â€ï¼š
> **ç»“æ„ä½“å¤§äº†å°±åˆ«ä¼ å€¼ï¼Œå¿«ç”¨æŒ‡é’ˆï¼Œä¸ç„¶æ‹·è´å¾ˆæ…¢ã€‚**

å¬èµ·æ¥éå¸¸åˆç†ï¼Œæ¯•ç«Ÿï¼Œæ‹·è´ä¸€ä¸ª 80 å­—èŠ‚çš„ç»“æ„ä½“ï¼Œæ€ä¹ˆçœ‹éƒ½æ¯”æ‹·è´ä¸€ä¸ª 8 å­—èŠ‚çš„æŒ‡é’ˆè¦æ…¢ï¼Œå¯¹å§ï¼Ÿ

å¬èµ·æ¥å¾ˆåˆç†ï¼Œä½†ä»Šå¤©æˆ‘è¦ç”¨å®éªŒå‘Šè¯‰ä½ ï¼š  

> **åœ¨ Go é‡Œï¼Œä¼ æŒ‡é’ˆå¯èƒ½æ¯”ä¼ å€¼æ…¢å¾—å¤šï¼** ğŸ˜±

##  å…ˆä¸Šå®éªŒï¼šè·‘ä¸ªåŸºå‡†æµ‹è¯•

æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªåŒ…å« 10 ä¸ª int64 å­—æ®µçš„ç»“æ„ä½“ï¼Œæ€»å¤§å° 80 å­—èŠ‚ï¼š

```go
type data struct { a, b, c, d, e, f, g, h, i, j int64}
```

åˆ†åˆ«å®ç°ä¸¤ç§æ„é€ æ–¹å¼è¿›è¡Œæ¯”è¾ƒï¼š

```go
// è¿”å›å€¼  80å­—èŠ‚
func newData(i int) data {
	data := data{int64(i), int64(i + 1), int64(i + 2), int64(i + 3), int64(i + 4), int64(i + 5), int64(i + 6), int64(i + 7), int64(i + 8), int64(i + 9)}
	return data
}

// è¿”å›æŒ‡é’ˆ 8å­—èŠ‚
func newDataPtr(i int) *data {
	data := &data{int64(i), int64(i + 1), int64(i + 2), int64(i + 3), int64(i + 4), int64(i + 5), int64(i + 6), int64(i + 7), int64(i + 8), int64(i + 9)}
	return data
}


var globalPtr *data
var globalValue data
func BenchmarkProcessValue(b *testing.B) {
	for i := 0; i < b.N; i++ {
		globalValue = newData(i)
	}
}

func BenchmarkProcessPointer(b *testing.B) {
	for i := 0; i < b.N; i++ {
		globalPtr = newDataPtr(i)
	}
}

```

ä½ çš„ç›´è§‰å¯èƒ½å‘Šè¯‰ä½ ï¼š`newDataPtr` åº”è¯¥æ›´å¿«ï¼Œå› ä¸ºå®ƒé¿å…äº†è¿”å›æ—¶çš„å…¨é‡æ‹·è´ã€‚

æˆ‘ä»¬å…ˆè·‘ benchmarkï¼ˆApple M1ï¼‰ï¼š

```text
BenchmarkProcessValue-8         392275122     3.045 ns/op    0 B/op    0 allocs/op
BenchmarkProcessPointer-8       62763009      18.55 ns/op   80 B/op    1 allocs/op
```

**ä¼ å€¼ï¼ˆValueï¼‰ç«Ÿç„¶æ¯”ä¼ æŒ‡é’ˆï¼ˆPointerï¼‰å¿«äº† 6 å€ä»¥ä¸Šï¼**
è€Œä¸”è¯·æ³¨æ„ï¼šä¼ å€¼å®ç°äº† **0 å†…å­˜åˆ†é…ï¼ˆ0 allocs/opï¼‰**ï¼Œè€Œä¼ æŒ‡é’ˆæ¯æ¬¡è°ƒç”¨éƒ½ä¼´éšç€å †å†…å­˜åˆ†é…ï¼ˆ80 B/opï¼‰ã€‚

è¿™å’Œæˆ‘ä»¬ç†ŸçŸ¥çš„â€œæ‹·è´å¤§ç»“æ„ä½“å¾ˆæ…¢â€å®Œå…¨ç›¸åã€‚

## ä¸ºä»€ä¹ˆä¼ æŒ‡é’ˆä¸ä¸€å®šå¿«ï¼Ÿ

å…³é”®ä¸åœ¨äºâ€œæ‹·è´å¤šå°‘å­—èŠ‚â€ï¼Œ

è€Œåœ¨äºï¼š**å®ƒæ˜¯åœ¨æ ˆä¸Šï¼Œè¿˜æ˜¯åœ¨å †ä¸Šã€‚**

### **ä¼ å€¼ â†’ æ ˆä¸Šåˆ†é…**

``````go
func newData() data {
    return data{...}
}
``````

æ ˆåˆ†é…æœ¬è´¨ï¼š

- ç§»åŠ¨æ ˆæŒ‡é’ˆï¼ˆSPï¼‰
- å‡½æ•°è¿”å›æ—¶è‡ªåŠ¨å›æ”¶
- **æ—  GC å‚ä¸ï¼Œé€Ÿåº¦æå¿«**

###  **è¿”å›æŒ‡é’ˆ â†’ é€ƒé€¸åˆ°å †**

``````go
func newDataPtr() *data {
    d := &data{}
    return d
}
``````

- æŒ‡é’ˆè¢«å¸¦å‡ºå‡½æ•°ï¼Œç¼–è¯‘å™¨åˆ¤æ–­å¯¹è±¡éœ€å †ä¸Šå­˜æ´»
- è§¦å‘ **é€ƒé€¸åˆ†æ**
- å †åˆ†é… + GC æ‰«æ + æŒ‡é’ˆè¿½è¸ª
- **ç»“æœæ¯”ä¼ å€¼æ…¢å¾—å¤š**

> å¾ˆå¤šäººä»¥ä¸ºâ€œæ‹·è´å¤§ç»“æ„ä½“æ…¢â€ï¼Œå…¶å®æ…¢çš„æ˜¯è®©å¯¹è±¡é€ƒé€¸åˆ°å †ä¸Šã€‚

## **çœŸæ­£çš„è¯¯åŒºï¼šæŠŠâ€œè¯­ä¹‰â€å’Œâ€œæ€§èƒ½â€æ··åœ¨ä¸€èµ·**

å¾ˆå¤šäººç”¨æŒ‡é’ˆï¼Œæ˜¯å‡ºäºä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ç†ç”±ï¼š

### **ç”¨æŒ‡é’ˆçš„æ­£ç¡®ç†ç”±**

``````go
func update(u *User) {
    u.Name = "Tom"
}
``````

- ä½ è¦ä¿®æ”¹åŸå¯¹è±¡ â†’ å¿…é¡»æŒ‡é’ˆ
- è¯­ä¹‰é—®é¢˜ï¼Œä¸æ˜¯æ€§èƒ½é—®é¢˜

### **é”™è¯¯ç†ç”±ï¼šä¸ºäº†â€œæ›´å¿«â€**

``````go
func process(d *Data)
``````

- â€œData æœ‰ç‚¹å¤§ï¼Œç”¨æŒ‡é’ˆæ›´å¿«å§ï¼Ÿâ€
- åœ¨ Go é‡Œï¼Œè¿™å¾€å¾€æ˜¯ **åæ•ˆæœ** 

## **é‚£åˆ°åº•ä»€ä¹ˆæ—¶å€™è¯¥ç”¨æŒ‡é’ˆï¼Ÿ**

å¯ä»¥è®°ä½ä»¥ä¸‹å‡ ä¸ªå®ç”¨åˆ¤æ–­ï¼š

### **ç”¨æŒ‡é’ˆçš„åœºæ™¯**

1. **éœ€è¦ä¿®æ”¹åŸå¯¹è±¡ï¼ˆå…±äº«çŠ¶æ€ï¼‰**
2. **ç»“æ„ä½“çœŸçš„å¾ˆå¤§ï¼ˆå‡  KB ä»¥ä¸Šå—ï¼Œå»ºè®®è¿˜æ˜¯é€šè¿‡åŸºå‡†æµ‹è¯•å¯¹æ¯”æ€§èƒ½é€‰æ‹©æœ€ä¼˜ï¼‰**
3. **æ–¹æ³•é›†å·²ç»ç”¨äº†æŒ‡é’ˆæ¥æ”¶è€…**

### **ä¼˜å…ˆä¼ å€¼çš„åœºæ™¯**

1. ç»“æ„ä½“æ˜¯**å‡ åå­—èŠ‚çº§åˆ«**
2. åªæ˜¯è¯»æ•°æ®ï¼Œä¸ä¿®æ”¹
3. åœ¨çƒ­è·¯å¾„ / é«˜é¢‘å‡½æ•°ä¸­
4. å¸Œæœ›å‡å°‘ GC å‹åŠ›

## å»¶ä¼¸

Go 1.26 çš„ new(expr) ä¹Ÿæ˜¯ä¸ºäº†ï¼š

- **ä¿æŒå€¼è¯­ä¹‰**
- **å‡å°‘ä¸´æ—¶å¯¹è±¡åˆ†é…**
- **å°½é‡ç•™åœ¨æ ˆä¸Šï¼Œè¿œç¦»å †**

## æ€»ç»“

> åœ¨ Go ä¸­ï¼š
> **æ…¢çš„ä¸æ˜¯æ‹·è´ structï¼Œæ…¢çš„æ˜¯è®©å¯¹è±¡é€ƒé€¸åˆ°å †ä¸Šã€‚**

å¾ˆå¤šæ—¶å€™ï¼š

- ä¼ å€¼ â†’ æ ˆåˆ†é… â†’ æ—  GC
- ä¼ æŒ‡é’ˆ â†’ å †åˆ†é… â†’ GC å‚ä¸

å¾ˆå¤šå¼€å‘è€…ä»¥ä¸ºä¼˜åŒ–æ€§èƒ½ï¼Œå®é™…ä¸Šæ˜¯åœ¨ç»™ GC åŠ ç­ã€‚

ä¸‹æ¬¡ä½ ä¹ æƒ¯æ€§æŒ‰ä¸‹ * é”®å‰ï¼Œå…ˆé—®è‡ªå·±ï¼š

> æˆ‘æ˜¯çœŸçš„è¦ä¿®æ”¹å®ƒï¼Ÿè¿˜æ˜¯åªæ˜¯â€œä¹ æƒ¯æ€§ç”¨æŒ‡é’ˆâ€ï¼Ÿ

**å¦‚æœåªæ˜¯ä¸ºäº†â€œæ›´å¿«â€ï¼Œå…ˆè·‘ Benchmarkï¼Œå†æ”¹ä»£ç ï¼** 